generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MEMBER
}

enum BorrowRequestStatus {
  PENDING
  APPROVED
  DECLINED
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  name          String
  picture       String?
  contactEmail  String?
  phoneNumber   String?
  personalId    String?        @unique
  readingPoints Int            @default(0)
  avatarPreset  String?
  backgroundPreset String?
  role          Role           @default(MEMBER)
  googleSub     String?        @unique
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  loans         Loan[]
  reviews       BookReview[]
  notes         BookNote[]
  favorites     BookFavorite[]
  borrowRequests BorrowRequest[] @relation("BorrowRequestUser")
  reviewedRequests BorrowRequest[] @relation("BorrowRequestReviewer")
  refreshTokens RefreshToken[]
  auditLogs     AuditLog[]     @relation("ActorAuditLogs")
}

model Book {
  id            String    @id @default(cuid())
  title         String
  author        String
  isbn          String?   @unique
  genre         String?
  publishedYear Int?
  description   String?
  coverUrl      String?
  averageRating Float?
  ratingsCount  Int?
  aiMetadata    Boolean   @default(false)
  available     Boolean   @default(true)
  requestPending Boolean  @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  loans         Loan[]
  reviews       BookReview[]
  notes         BookNote[]
  favorites     BookFavorite[]
  borrowRequests BorrowRequest[]

  @@index([title])
  @@index([author])
  @@index([genre])
  @@index([available])
  @@index([requestPending])
  @@index([averageRating])
}

model BookFavorite {
  id        String   @id @default(cuid())
  userId    String
  bookId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  book      Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([bookId, userId])
  @@index([userId, updatedAt])
  @@index([bookId, updatedAt])
}

model BorrowRequest {
  id           String              @id @default(cuid())
  userId       String
  bookId       String
  status       BorrowRequestStatus @default(PENDING)
  reviewedById String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  reviewedAt   DateTime?
  memberSeenAt DateTime?
  user         User                @relation("BorrowRequestUser", fields: [userId], references: [id], onDelete: Cascade)
  book         Book                @relation(fields: [bookId], references: [id], onDelete: Cascade)
  reviewedBy   User?               @relation("BorrowRequestReviewer", fields: [reviewedById], references: [id], onDelete: SetNull)

  @@index([bookId, status])
  @@index([userId, status, memberSeenAt])
}

model BookReview {
  id        String   @id @default(cuid())
  userId    String
  bookId    String
  rating    Int
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  book      Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([bookId, userId])
  @@index([bookId, updatedAt])
}

model BookNote {
  id        String   @id @default(cuid())
  userId    String
  bookId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  book      Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([bookId, userId])
  @@index([bookId, updatedAt])
}

model Loan {
  id           String   @id @default(cuid())
  userId       String
  bookId       String
  checkedOutAt DateTime @default(now())
  dueAt        DateTime?
  returnedAt   DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  book         Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([bookId, returnedAt])
  @@index([userId, returnedAt])
}

model RefreshToken {
  id          String   @id @default(cuid())
  userId      String
  tokenHash   String   @unique
  expiresAt   DateTime
  revokedAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AuditLog {
  id          String   @id @default(cuid())
  actorUserId String?
  action      String
  entity      String
  entityId    String?
  metadata    Json?
  createdAt   DateTime @default(now())
  actor       User?    @relation("ActorAuditLogs", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([action])
  @@index([entity])
}
