generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MEMBER
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  name          String
  picture       String?
  role          Role           @default(MEMBER)
  googleSub     String?        @unique
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  loans         Loan[]
  refreshTokens RefreshToken[]
  auditLogs     AuditLog[]     @relation("ActorAuditLogs")
}

model Book {
  id            String    @id @default(cuid())
  title         String
  author        String
  isbn          String?   @unique
  genre         String?
  publishedYear Int?
  description   String?
  coverUrl      String?
  averageRating Float?
  ratingsCount  Int?
  available     Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  loans         Loan[]

  @@index([title])
  @@index([author])
  @@index([genre])
  @@index([available])
  @@index([averageRating])
}

model Loan {
  id           String   @id @default(cuid())
  userId       String
  bookId       String
  checkedOutAt DateTime @default(now())
  dueAt        DateTime?
  returnedAt   DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  book         Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([bookId, returnedAt])
  @@index([userId, returnedAt])
}

model RefreshToken {
  id          String   @id @default(cuid())
  userId      String
  tokenHash   String   @unique
  expiresAt   DateTime
  revokedAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AuditLog {
  id          String   @id @default(cuid())
  actorUserId String?
  action      String
  entity      String
  entityId    String?
  metadata    Json?
  createdAt   DateTime @default(now())
  actor       User?    @relation("ActorAuditLogs", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([action])
  @@index([entity])
}
